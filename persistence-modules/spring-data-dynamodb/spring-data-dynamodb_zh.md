# [使用Spring Data的Spring Boot应用程序中的DynamoDB](https://www.baeldung.com/spring-data-dynamodb)

1. 一览表

    在本文中，我们将通过一个动手的、实用的示例项目来探索将DynamoDB集成到Spring Boot应用程序中的基础知识。

    我们将演示如何使用Spring Data配置应用程序以使用本地DynamoDB实例。我们还将创建一个示例数据模型和存储库类，并使用集成测试执行实际的数据库操作。

2. 发电机数据库

    DynamoDB是AWS上完全托管的NoSQL数据库，类似于Cassandra或MongoDB。它提供快速、一致和可预测的性能，并且具有巨大的可扩展性。

    您可以在[AWS文档](https://aws.amazon.com/dynamodb/details/)上了解有关DynamoDB的更多信息。

    让我们安装DynamoDB的本地实例，以避免产生运行实时实例的成本。

    对于开发，本地运行DynamoDB比在AWS上运行更有意义；本地实例将作为可执行的JAR文件运行。

    您可以在这里找到有关如何在本地[运行DynamoDB的说明](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.html)。

3. Maven附属机构

    让我们从添加必要的依赖项开始，开始使用Spring Data使用DynamoDB：

    ```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.data</groupId>
            <artifactId>spring-data-commons</artifactId>
            <version>2.7.18</version>
        </dependency>
        <dependency>
            <groupId>com.amazonaws</groupId>
            <artifactId>aws-java-sdk-dynamodb</artifactId>
            <version>1.12.714</version>
        </dependency>
        <dependency>
            <groupId>com.github.derjust</groupId>
            <artifactId>spring-data-dynamodb</artifactId>
            <version>5.1.0</version>
        </dependency>
    </dependencies>
    ```

    我们必须获取最新版本的Spring Data Commons、AWS Java SDK For Amazon DynamoDB和Spring Data DynamoDB。

4. 配置

    接下来，让我们在 application.properties 文件中定义以下属性：

    ```properties
    amazon.dynamodb.endpoint=http://localhost:8000/
    amazon.aws.accesskey=key
    amazon.aws.secretkey=key2
    ```

    上面列出的访问和密钥只是本地配置的任意值。访问DynamoDB的本地实例时，这些字段需要填充一些值，但不需要它们进行身份验证。

    属性将从Spring配置中的application.properties文件中动态提取：

    ```java
    @Configuration
    @EnableDynamoDBRepositories
    (basePackages = "com.baeldung.spring.data.dynamodb.repositories")
    public class DynamoDBConfig {

        @Value("${amazon.dynamodb.endpoint}")
        private String amazonDynamoDBEndpoint;

        @Value("${amazon.aws.accesskey}")
        private String amazonAWSAccessKey;

        @Value("${amazon.aws.secretkey}")
        private String amazonAWSSecretKey;

        @Bean
        public AmazonDynamoDB amazonDynamoDB() {
            AmazonDynamoDB amazonDynamoDB 
            = new AmazonDynamoDBClient(amazonAWSCredentials());
            
            if (!StringUtils.isEmpty(amazonDynamoDBEndpoint)) {
                amazonDynamoDB.setEndpoint(amazonDynamoDBEndpoint);
            }
            
            return amazonDynamoDB;
        }

        @Bean
        public AWSCredentials amazonAWSCredentials() {
            return new BasicAWSCredentials(
            amazonAWSAccessKey, amazonAWSSecretKey);
        }
    }
    ```

5. 数据模型

    现在让我们创建一个POJO模型来表示存储在DynamoDB中的数据。

    此POJO将使用类似于Hibernate中使用的注释来定义表的表名、属性、键和其他方面。

    1. 数据模型属性

        以下类ProductInfo表示一个包含3个属性的项目表：

        - ID
        - MSRP
        - Cost

    2. Java数据模型类

        让我们在您的数据模型文件夹中创建一个名为ProductInfo.java的文件：

        ```java
        @DynamoDBTable(tableName = "ProductInfo")
        public class ProductInfo {
            private String id;
            private String msrp;
            private String cost;

            @DynamoDBHashKey
            @DynamoDBAutoGeneratedKey
            public String getId() {
                return id;
            }

            @DynamoDBAttribute
            public String getMsrp() {
                return msrp;
            }

            @DynamoDBAttribute
            public String getCost() {
                return cost;
            }

            // standard setters/constructors
        }
        ```

6. CRUD存储库

    接下来，我们需要创建一个ProductRepository接口来定义我们想要构建的CRUD功能。用于读取和保存DynamoDB和保存数据的存储库将实现此接口：

    ```java
    @EnableScan
    public interface ProductInfoRepository extends
    CrudRepository<ProductInfo, String> {

        Optional<ProductInfo> findById(String id);
    }
    ```

7. 集成测试

    接下来，让我们创建一个集成测试，以确保我们可以成功连接到DynamoDB的本地实例：

    ```java
    @RunWith(SpringJUnit4ClassRunner.class)
    @SpringBootTest(classes = Application.class)
    @WebAppConfiguration
    @ActiveProfiles("local")
    @TestPropertySource(properties = {
    "amazon.dynamodb.endpoint=<http://localhost:8000/>",
    "amazon.aws.accesskey=test1",
    "amazon.aws.secretkey=test231" })
    public class ProductInfoRepositoryIntegrationTest {

        private DynamoDBMapper dynamoDBMapper;

        @Autowired
        private AmazonDynamoDB amazonDynamoDB;

        @Autowired
        ProductInfoRepository repository;

        private static final String EXPECTED_COST = "20";
        private static final String EXPECTED_PRICE = "50";

        @Before
        public void setup() throws Exception {
            dynamoDBMapper = new DynamoDBMapper(amazonDynamoDB);
            
            CreateTableRequest tableRequest = dynamoDBMapper
            .generateCreateTableRequest(ProductInfo.class);
            tableRequest.setProvisionedThroughput(
            new ProvisionedThroughput(1L, 1L));
            amazonDynamoDB.createTable(tableRequest);
            
            //...

            dynamoDBMapper.batchDelete(
            (List<ProductInfo>)repository.findAll());
        }

        @Test
        public void givenItemWithExpectedCost_whenRunFindAll_thenItemIsFound() { 
            ProductInfo productInfo = new ProductInfo(EXPECTED_COST, EXPECTED_PRICE);
            repository.save(productInfo); 
            List<ProductInfo> result = (List<ProductInfo>) repository.findAll();

            assertThat(result.size(), is(greaterThan(0)));
            assertThat(result.get(0).getCost(), is(equalTo(EXPECTED_COST))); 
        }
    }
    ```

8. 结论

    我们完成了——我们现在可以从Spring Boot应用程序连接到DynamoDB。

    当然，在本地完成测试后，我们应该能够透明地使用AWS上的DynamoDB的实时实例，并仅通过小幅配置更改来运行已部署的代码。
