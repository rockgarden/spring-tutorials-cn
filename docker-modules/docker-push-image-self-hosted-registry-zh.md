# 将Docker镜像推送到自我托管的注册中心

1. 概述
    本教程将演示如何将Docker镜像推送到自营的Docker注册中心。首先，我们将探讨什么是自我托管的注册中心，以及它与公共注册中心有什么不同。然后，我们将学习如何标记我们想要推送到自我托管的注册中心的镜像。最后，我们将看到如何实际推送这些镜像。
2. 自我托管的Docker注册中心
    Docker注册中心是一个管理容器镜像库的服务。它允许我们做一些事情，比如创建存储库、推送和拉动镜像，以及管理存储库访问。虽然许多注册中心是作为云服务提供的，但注册中心也可能是自我托管的。
    当一个储存库通过云提供时，我们不必关心它的托管和维护。我们只需在该服务上注册，然后使用所提供的功能。云托管的Docker注册中心也被称为公共注册中心。Docker Hub是一个著名的公共注册中心的例子。
    然而，如果一个公司有特殊要求，公共注册中心可能不是一个选择。不能使用公共储存库的公司通常有自我托管的储存库，他们可以根据自己的要求进行定制。例如，一家公司可能有一个隐私政策，要求存储库只能通过公司的内部网络访问。或者一家公司可能需要对其镜像进行特定的漏洞扫描。
3. 为自我托管的注册中心的镜像打上标签
    我们必须以特定的方式对镜像进行标记，然后才能将它们推送到自我托管的注册中心。让我们来学习如何适当地标记镜像。
    1. 图像名称模式
        当推送镜像时，图像名称定义了该镜像将被推送到哪里。这就是为什么，为了推送一个镜像到一个自我托管的注册中心，我们必须使用正确的命名模式。镜像名称必须包含注册中心主机、端口和存储库名称，并且可以选择在后面加上一个版本标签：

        `[registry host]:[registry port]/[repository name]:[tag name]`

        假设我们有一个运行在 localhost 上的储存库，监听端口为 5000。下面是一个版本为1.0.0的镜像的例子，我们想把它推送到该注册中心的my-fancy-app仓库：

        `localhost:5000/my-fancy-app:1.0.0`

        我们将在本文的其余部分使用这个例子。
        现在我们知道了应用什么命名模式，我们可以为我们的自我托管的注册中心准备一个镜像。首先，我们将看到如何用正确的名字建立一个新的镜像。然后我们将学习如何通过重命名来准备一个现有的镜像。
    2. 给一个新的映像贴标签

        如果我们要构建一个新的镜像，并且已经准备好了一个应用程序和Docker文件，我们可以使用docker build命令的-t标志，这样镜像就会以适当的名称被创建。使用上一节中的例子，该命令将是：

        `$ docker build -t localhost:5000/my-fancy-app:1.0.0 .`

        这就给新镜像打上了正确的名字，后面是可选的版本标签。行末的点"."表示我们在与Docker文件相同的目录中执行该命令。
    3. 重新标记一个现有的镜像
        如果我们想把一个现有的镜像推送到我们的自我托管注册中心，我们首先需要用一个新的别名来标记这个镜像，这个别名要符合我们上面描述的命名模式。我们可以用docker tag命令来重新标记一个图像：

        `docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]`

        例如，假设我们想推送一个名为my-fancy-app:1.0.0的现有镜像到我们的自我托管注册中心。我们将简单地使用docker tag命令，用一个新的别名来标记它，以匹配该注册表：

        `$ docker tag my-fancy-app:1.0.0 localhost:5000/my-fancy-app:1.0.0`
4. 推送镜像
    一旦我们正确地标记了一个镜像，我们就可以把它推送到我们的自我托管的注册中心。
    公司通常需要认证来保护他们的自我托管的注册表。在这种情况下，我们首先需要用docker login命令来登录：

    `docker login [OPTIONS] [SERVER]`

    对于我们托管在localhost:5000上的自托管注册表，命令是：

    `$ docker login localhost:5000`

    登录后，我们使用docker push命令来推送一个镜像到我们的自我托管的注册中心：

    `docker push [OPTIONS] NAME[:TAG]`

    让我们看看推送我们在上面的章节中准备的镜像的命令：

    `$ docker push localhost:5000/my-fancy-app:1.0.0`
5. 验证推送

    最后一步是验证镜像是否在我们的自我托管的注册中心中可用。要做到这一点，我们将从该注册表拉出镜像，但我们必须首先通过运行docker image rm命令删除我们缓存的本地镜像：

    `$ docker image rm localhost:5000/my-fancy-app:1.0.0`

    让我们通过列出所有的本地镜像并检查我们的镜像是否不在其中来验证我们删除了镜像：

    `$ docker images`

    接下来，让我们使用docker pull命令从我们的自我托管的注册表中提取图像：

    `$ docker pull localhost:5000/my-fancy-app:1.0.0`

    通过再次列出所有本地镜像，我们可以验证我们的镜像已经成功地从自我托管的注册中心中拉出：

    ```bash
    $ docker images
    REPOSITORY                  TAG   IMAGE ID     CREATED        SIZE 
    localhost:5000/my-fancy-app 1.0.0 d33a5b65c0f5 20 minutes ago 326MB
    ```

6. 总结

    在这篇文章中，我们已经了解了什么是自我托管的Docker注册库，以及为什么我们可能会使用它们。我们还探讨了如何准备一个镜像--无论是预先存在的镜像还是我们正在构建的新镜像--以便我们可以将其推送到自托管注册中心。最后，我们学习了如何将正确标记的镜像推送到我们的示例注册中心。

## 相关文章

- [x] [Pushing a Docker Image to a Self-Hosted Registry](https://www.baeldung.com/ops/docker-push-image-self-hosted-registry)
