# 为什么字符串在Java中是不可变的？

1. 简介

    在Java中，字符串是不可变的。在采访中，一个很明显的问题是 "为什么字符串在Java中被设计成不可变的？"

    Java的创造者James Gosling[曾经在一次采访中](https://www.artima.com/intv/gosling313.html)被问到什么时候应该使用不可变的，他回答说：

    只要有可能，我就会使用不可变的。

    他进一步支持他的论点，陈述了不可变性所提供的功能，如缓存、安全、无需复制即可轻松重用等。

    在本教程中，我们将进一步探讨为什么Java语言设计者决定保持String的不可变性。

2. 什么是不可变的对象？

    不可变的对象是一个在完全创建后内部状态保持不变的对象。这意味着一旦该对象被分配给一个变量，我们既不能更新引用，也不能以任何方式改变内部状态。

    我们有一篇单独的文章详细讨论了不可变的对象。欲了解更多信息，请阅读[《Java中的不可变对象》](https://www.baeldung.com/java-immutable-object)一文。

3. 为什么Java中的字符串是不可变的？

    把这个类保持为不可变的关键好处是缓存、安全、同步和性能。

    让我们来讨论一下这些东西是如何工作的。

    1. 介绍一下字符串池

        字符串是最广泛使用的数据结构。缓存String字面意义并重用它们可以节省大量的堆空间，因为不同的String变量在String池中引用的是同一个对象。字符串实习池(String intern pool)正是为此服务的。

        Java字符串池是JVM存储字符串的特殊内存区域。由于字符串在Java中是不可改变的，JVM通过在池中只存储每个字面字符串的一个副本来优化分配给它们的内存量。这个过程被称为interning：

        ```java
        String s1 = "Hello World";
        String s2 = "Hello World";    
        assertThat(s1 == s2).isTrue();
        ```

        由于前面的例子中存在字符串池，两个不同的变量都指向池中的同一个字符串对象，从而节省了关键的内存资源。

        ![为什么Java中的字符串是不可变的](/pic/Why_String_Is_Immutable_In_Java.jpg)

        我们有一篇单独的文章专门介绍Java字符串池。欲了解更多信息，请前往[该文章](https://www.baeldung.com/java-string-pool)。

    2. 安全性

        在Java应用程序中，字符串被广泛用于存储敏感信息，如用户名、密码、连接URL、网络连接等。它也被JVM类加载器在加载类时广泛使用。

        因此，确保String类的安全对于整个应用程序的安全来说是至关重要的。例如，考虑这个简单的代码片断：

        ```java
        void criticalMethod(String userName) {
            // perform security checks
            if (!isAlphaNumeric(userName)) {
                throw new SecurityException(); 
            }
            // do some secondary tasks
            initializeDatabase();
            // critical task
            connection.executeUpdate("UPDATE Customers SET Status = 'Active' " +
            " WHERE UserName = '" + userName + "'");
        }
        ```

        在上面的代码片段中，假设我们从一个不可信的来源收到一个字符串对象。我们最初做了所有必要的安全检查，以检查该字符串是否只是字母数字，然后再进行一些操作。

        请记住，我们不可靠的源调用者方法仍然有对这个userName对象的引用。

        如果字符串是可变的，那么当我们执行更新时，我们不能确定我们收到的字符串，即使在执行了安全检查后，也是安全的。不值得信任的调用者方法仍然拥有引用，可以在完整性检查之间改变String。因此，在这种情况下，我们的查询很容易被SQL注入。因此，易变的字符串可能会导致安全性随着时间的推移而降低。

        也有可能发生的情况是，字符串userName对另一个线程是可见的，它可以在完整性检查后改变其值。

        一般来说，在这种情况下，不可变性会对我们有所帮助，因为当值不发生变化时，对敏感代码的操作会更容易，因为可能影响结果的交错操作更少。

    3. 同步化

        不可变的对象会自动使字符串成为线程安全的，因为它们在被多个线程访问时不会被改变。

        因此，不可变的对象，一般来说，可以在同时运行的多个线程中共享。它们也是线程安全的，因为如果一个线程改变了值，那么将在字符串池中创建一个新的字符串，而不是修改相同的值。因此，字符串对多线程是安全的。

    4. 哈希码缓存

        由于字符串对象被大量用作数据结构，它们也被广泛用于散列实现，如HashMap、HashTable、HashSet等。当对这些哈希实现进行操作时，hashCode()方法会被频繁地调用，以便进行缓存。

        不变性保证了字符串的值不会改变。所以hashCode()方法在String类中被重载，以方便缓存，这样在第一次调用hashCode()时就会计算并缓存哈希值，此后就会返回相同的值。

        这反过来又提高了使用哈希实现的集合在操作String对象时的性能。

        另一方面，如果操作后String的内容被修改，可变的String在插入和检索时将产生两个不同的哈希码，有可能丢失Map中的值对象。

    5. 性能

        正如我们之前看到的，字符串池的存在是因为字符串是不可变的。反过来，当对字符串进行操作时，它可以通过节省堆内存和加快哈希实现的访问来提高性能。

        由于字符串是使用最广泛的数据结构，提高字符串的性能对提高整个应用程序的性能有很大的影响。

4. 总结

    通过这篇文章，我们可以得出结论，字符串是不可变的，这正是因为它们的引用可以被视为一个普通的变量，人们可以在方法之间和线程之间传递它们，而不必担心它所指向的实际字符串对象是否会改变。

    我们还了解到，促使Java语言设计者把这个类变成不可变的其他原因是什么。
